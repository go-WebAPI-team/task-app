<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>タスク詳細</title>
</head>
<body>
  <h1 id="task-title"></h1>
  <p id="task-desc"></p>
  <p>締切: <span id="task-deadline"></span></p>
  <p>優先度: <span id="task-priority"></span></p>
  <p>
    完了: <span id="task-done"></span>
    <button id="toggle-done-btn">切り替え</button>
  </p>
  <a href="dashboard.html">← 一覧へ戻る</a>
  <script>
    // クエリパラメータからid取得
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    let currentIsDone = false;

    function renderTask(task) {
      document.getElementById('task-title').textContent = task.title;
      document.getElementById('task-desc').textContent = task.description;
      document.getElementById('task-deadline').textContent = task.deadline ? new Date(task.deadline).toLocaleString() : '';
      document.getElementById('task-priority').textContent = task.priority;
      document.getElementById('task-done').textContent = task.is_done ? '完了' : '未完了';
      currentIsDone = task.is_done;
    }

    if (!id) {
      document.body.innerHTML = '<p>タスクIDが指定されていません</p>';
    } else {
      fetch(`/tasks/${id}`)
        .then(res => res.json())
        .then(task => {
          renderTask(task);
        })
        .catch(() => {
          document.body.innerHTML = '<p>タスクが見つかりません</p>';
        });

      document.getElementById('toggle-done-btn').addEventListener('click', async () => {
        // 完了状態をトグル
        const newIsDone = !currentIsDone;
        const res = await fetch(`/tasks/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_done: newIsDone })
        });
        if (res.ok) {
          const updated = await res.json();
          renderTask(updated);
        } else {
          alert('完了状態の更新に失敗しました');
        }
      });
    }
  </script>
</body>
</html>